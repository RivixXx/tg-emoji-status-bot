# 🏆 Karina AI: MVP Done

## ✅ Основной функционал (MVP)

### 1. 🧠 Интеллектуальные "Мозги" (Mistral AI)
- **Модель**: `mistral-small-latest` (через официальный API).
- **Function Calling**: Карина сама понимает, когда нужно вызвать инструменты.
- **Стиль**: Живой, дружелюбный, игривый, с эмодзи.
- **Системный промт**: 100+ строк с детальным описанием личности и правил.

### 2. 💾 Долговременная память (RAG + Supabase)
- **Технология**: Векторный поиск (pgvector) через Supabase.
- **Механизм**: Перед каждым ответом Карина ищет в базе факты, похожие на вопрос.
- **Обучение**: Команда `/remember` позволяет вручную обучать её важным датам.
- **Retry-логика**: Автоматические повторные попытки при 429 ошибках.

### 3. 📅 Интеграция с Google Calendar
- **Чтение**: Команда `/calendar` выводит список встреч из всех календарей.
- **Запись**: Карина может создавать события через Function Calling.
- **Конфликты**: Команда `/conflicts` проверяет накладки в расписании.
- **Кэширование**: TTL 5 минут для снижения нагрузки на API.

### 4. 🎤 Голосовое управление
- **STT**: Бесплатная транскрибация через Hugging Face Whisper.
- **Обработка**: Голосовые сообщения конвертируются в текст и обрабатываются.

### 5. 🌀 Система Аур (Автоматизация)
- **Emoji-статус**: Авто-смена в зависимости от времени дня и дня недели.
- **Динамическое БИО**: Смена описания профиля в рабочее время.
- **Утренний брифинг**: Погода + RSS Habr (транспорт/телематика).
- **Забота о здоровье**: Напоминания (22:00) с подтверждением и "ворчанием".
- **Обработка ошибок**: Авто-переподключение при `PersistentTimestampOutdatedError`.

### 6. 📱 Telegram Mini App
- **3D-панель**: Пузырьковый интерфейс с анимацией.
- **Эмоциональный движок**: 6 эмоций + цветовые темы (positive, sad, angry, etc.).
- **Health Dashboard**: Статистика уколов, прогресс-бар, история.
- **Вкладки**: Планы, Память, Статус, Здоровье.

### 7. 🔔 Умные напоминания
- **Здоровье**: Ежедневные напоминания об уколе (22:00) с эскалацией
- **Встречи**: Напоминания за 15 минут до встречи из календаря
- **Обед**: Напоминание в 13:00 ежедневно
- **Утро/Вечер**: Приветствия и напоминания об отдыхе
- **Интерактивные кнопки**: Подтверждение, отсрочка, пропуск
- **AI-генерация**: Креативные непредсказуемые формулировки через Mistral AI
- **Эскалация**: 4 уровня (soft → firm → strict → urgent)

### 8. 🛠 Надёжность
- **Retry-логика**: Mistral API (429 errors) — 3 попытки с задержкой
- **Обработка ошибок**: Telegram connection errors, Supabase errors
- **Логирование**: Детальные логи для отладки
- **Архитектура**: Bot + UserBot в отдельных потоках, веб-сервер отдельно

### 9. 🏠 Домашний сервер (Ubuntu)
- **Развёртывание**: Полная инструкция для Ubuntu 22.04
- **Docker**: Docker Compose для PostgreSQL + Ollama + Bot
- **Авто-деплой**: Скрипт `deploy.sh` для обновления при пуше
- **Фоновый запуск**: nohup + systemd для автономной работы

---

## 📜 Системный Промпт

**Полная версия**: [`SYSTEM_PROMPT.md`](SYSTEM_PROMPT.md)

### Ключевые разделы:
1. **Личность**: Карина — заботливая помощница Михаила (эксперта в телематике).
2. **Тон**: Живой, тёплый, с лёгкой игривостью, 1-3 эмодзи на сообщение.
3. **Правила**: Do's & Don'ts, приоритеты (здоровье > планы > работа).
4. **RAG**: 4 правила работы с памятью.
5. **Инструменты**: 5 функций с триггерами.
6. **Контекст**: Время суток влияет на предложения.

---

## 🛠 Технический стек

| Компонент | Технология |
|-----------|------------|
| **Язык** | Python 3.10+ |
| **Frameworks** | Telethon (Telegram API), Quart (ASGI Web) |
| **Hosting** | Railway / Домашний сервер (Ubuntu 22.04) |
| **Database** | Supabase (PostgreSQL + pgvector) |
| **AI** | Mistral AI API (Embeddings & Chat) |
| **Calendar** | Google Calendar API (Service Account) |
| **Voice** | Hugging Face Whisper (STT) |
| **Frontend** | React + Tailwind CSS (Mini App) |
| **Container** | Docker, Docker Compose |

---

## 📊 Архитектура

```
┌─────────────────────────────────────────────────────┐
│         Railway / Домашний сервер (Ubuntu)          │
│                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │
│  │   Bot Thread │  │ UserBot Thread│  │ Web Thread│ │
│  │  (messages)  │  │  (emoji status)│  │  (Quart)  │ │
│  │              │  │               │  │           │ │
│  │  - Handlers  │  │  - Aura Loop  │  │ - Mini App│ │
│  │  - Commands  │  │  - Emoji API  │  │ - API     │ │
│  └──────┬───────┘  └───────┬───────┘  └─────┬─────┘ │
│         │                   │                 │       │
│         └───────────────────┴─────────────────┘       │
│                          │                            │
│              ┌───────────┴───────────┐                │
│              │   asyncio.gather()    │                │
│              └───────────────────────┘                │
└─────────────────────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐
    │ Telegram│    │ Mistral │    │Supabase │
    │   API   │    │   AI    │    │  (RAG)  │
    └─────────┘    └─────────┘    └─────────┘
```

---

## 🎯 Актуальные команды

| Команда | Описание |
|---------|----------|
| `/start` | Перезапустить Карину 🔄 |
| `/app` | Открыть Mini App 📱 |
| `/calendar` | Показать планы 📅 |
| `/conflicts` | Проверить накладки ⚠️ |
| `/health` | Статистика здоровья ❤️ |
| `/news` | Новости транспорта 🗞 |
| `/weather` | Прогноз погоды 🌤 |
| `/remember` | Запомнить факт ✍️ |
| `/link_email` | Привязать Google Календарь 📧 |
| `/clearrc` | Очистить кэш напоминаний 🧹 |

---

## 📈 Метрики

- **Время ответа AI**: ~2-5 секунд
- **RAG поиск**: ~1-2 секунды
- **Кэширование календаря**: TTL 5 минут
- **Retry задержки**: 2s, 4s, 6s
- **Ауры**: Проверка каждые 60 секунд
- **Напоминания**: Проверка каждые 60 секунд

---

## 🔄 Рабочий процесс разработки

### На ПК (Windows):
```bash
# Разработка
# Редактируй файлы...

# Деплой
git add .
git commit -m "feat: новое улучшение"
git push
```

### На сервере (Ubuntu):
```bash
# Ручной деплой
~/deploy.sh

# Просмотр логов
tail -f ~/tg-emoji-status-bot/bot.log

# Статус бота
ps aux | grep python

# Перезапуск
pkill -f "python main.py"
~/deploy.sh
```

---

**MVP готово к продакшену!** 🚀
