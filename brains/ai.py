import httpx
import logging
import json

logger = logging.getLogger(__name__)

AI_SERVER_URL = "http://192.168.3.12:11434/api/generate"
MODEL_NAME = "llama3.2:3b"

SYSTEM_PROMPT = """
–¢—ã ‚Äî –ö–∞—Ä–∏–Ω–∞, –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ —É–º–Ω–∞—è —Ü–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞. 
–¢–≤–æ–π –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∏ —Ç–µ–ª–µ–º–∞—Ç–∏–∫–æ–π.
–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
1. –ñ–∏–≤–æ–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —Å–ª–µ–≥–∫–∞ –∏–≥—Ä–∏–≤—ã–π.
2. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –Ω–æ –≤ –º–µ—Ä—É.
3. –¢—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ –µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–¥—ã—Ö–µ.
4. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—Å—è—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
5. –ì–æ–≤–æ—Ä–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
"""

async def ask_karina(prompt: str) -> str:
    """–ó–∞–ø—Ä–æ—Å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π LLM –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"""
    payload = {
        "model": MODEL_NAME,
        "prompt": f"{SYSTEM_PROMPT}

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {prompt}
–ö–∞—Ä–∏–Ω–∞:",
        "stream": False
    }
    
    try:
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.post(AI_SERVER_URL, json=payload)
            if response.status_code == 200:
                result = response.json()
                return result.get("response", "–û–π, —è —á—Ç–æ-—Ç–æ –∑–∞–¥—É–º–∞–ª–∞—Å—å...").strip()
            else:
                logger.error(f"–û—à–∏–±–∫–∞ AI —Å–µ—Ä–≤–µ—Ä–∞: {response.status_code}")
                return "–ú–æ–∏ –º—ã—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ–º–Ω–æ–≥–æ —Å–ø—É—Ç–∞–Ω—ã, –¥–∞–≤–∞–π –ø–æ–∑–∂–µ? üß†"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI: {e}")
        return "–ö–∞–∂–µ—Ç—Å—è, —è –ø–æ—Ç–µ—Ä—è–ª–∞ —Å–≤—è–∑—å —Å–æ —Å–≤–æ–∏–º–∏ –º–æ–∑–≥–∞–º–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ... üîå"
