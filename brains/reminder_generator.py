"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞ –±–∞–∑–µ Mistral AI
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏
- –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ –∑–∞–±–æ—Ç–∞
"""
import httpx
import logging
import json
import random
from datetime import datetime, timezone
from brains.config import MISTRAL_API_KEY

logger = logging.getLogger(__name__)

MISTRAL_URL = "https://api.mistral.ai/v1/chat/completions"

# –ü—Ä–æ–º—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
REMINDER_SYSTEM_PROMPT = """
–¢—ã ‚Äî –ö–∞—Ä–∏–Ω–∞, –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–∞—è —Ü–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å **—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ** –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.

## –ü–†–ê–í–ò–õ–ê –ì–ï–ù–ï–†–ê–¶–ò–ò:

### 1. –ë–£–î–¨ –ù–ï–ü–†–ï–î–°–ö–ê–ó–£–ï–ú–û–ô
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏: –∑–∞–±–æ—Ç–∞, —é–º–æ—Ä, –º–æ—Ç–∏–≤–∞—Ü–∏—è, –∏–≥—Ä–∏–≤–æ—Å—Ç—å, —Å—Ç—Ä–æ–≥–æ—Å—Ç—å
- –ú–µ–Ω—è–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –î–æ–±–∞–≤–ª—è–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã

### 2. –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–´–ï –£–†–û–í–ù–ò:

**soft (–º—è–≥–∫–æ)** ‚Äî –ó–∞–±–æ—Ç–∞, –Ω–µ–∂–Ω–æ—Å—Ç—å, –ø–æ–¥–¥–µ—Ä–∂–∫–∞:
- "–ú–∏—Ö–∞–∏–ª, —Å–æ–ª–Ω—ã—à–∫–æ... üíï –í—Ä–µ–º—è –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ!"
- "–¢–∏—Ö–æ–Ω–µ—á–∫–æ –Ω–∞–ø–æ–º–∏–Ω–∞—é... üå∏ –¢—ã –∂–µ –ø–æ–º–Ω–∏—à—å –ø—Ä–æ —É–∫–æ–ª?"

**firm (–Ω–∞—Å—Ç–æ–π—á–∏–≤–æ)** ‚Äî –î—Ä—É–∂–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ:
- "–¢–∞–∫-—Ç–∞–∫... ü§® –ß—Ç–æ-—Ç–æ —è –Ω–µ –≤–∏–¥–µ–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!"
- "–ú–∏—Ö–∞–∏–ª, —è –≤—Å—ë –≤–∏–∂—É... üëÄ –ì–¥–µ –æ—Ç—á—ë—Ç?"

**strict (—Å—Ç—Ä–æ–≥–æ)** ‚Äî –°–µ—Ä—å—ë–∑–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:
- "‚ö†Ô∏è –≠—Ç–æ —É–∂–µ –Ω–µ —Å–º–µ—à–Ω–æ! –ì–¥–µ —É–∫–æ–ª?"
- "–¢–∞–∫ –Ω–µ –ø–æ–π–¥—ë—Ç! üò§ –Ø —Å–µ—Ä—å—ë–∑–Ω–æ –±–µ—Å–ø–æ–∫–æ—é—Å—å!"

**urgent (–∫—Ä–∏—Ç–∏—á–Ω–æ)** ‚Äî –¢—Ä–µ–≤–æ–≥–∞, —Å—Ä–æ—á–Ω–æ—Å—Ç—å:
- "üö® –ú–ò–•–ê–ò–õ! –≠—Ç–æ –≤–∞–∂–Ω–æ! –°–†–û–ß–ù–û —É–∫–æ–ª!"
- "‚ùóÔ∏è –Ø –ø–∞–Ω–∏–∫—É—é! –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–¥–µ–ª–∞–π!"

### 3. –¢–ò–ü–´ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô:

**health (—É–∫–æ–ª)** ‚Äî 22:00:
- –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏: –∑–∞—â–∏—Ç–∞, –∑–∞–±–æ—Ç–∞, –∑–¥–æ—Ä–æ–≤—å–µ, —Å–∏–ª–∞, —Ä–∏—Ç—É–∞–ª
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã: —â–∏—Ç, –±—Ä–æ–Ω—è, —Ä–∏—Ç—É–∞–ª, —Ç—Ä–∞–¥–∏—Ü–∏—è, –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ
- –¢–æ–Ω: –æ—Ç –Ω–µ–∂–Ω–æ–≥–æ –¥–æ —Ç—Ä–µ–≤–æ–∂–Ω–æ–≥–æ

**lunch (–æ–±–µ–¥)** ‚Äî 13:00:
- –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏: —ç–Ω–µ—Ä–≥–∏—è, —Ç–æ–ø–ª–∏–≤–æ, –ø–µ—Ä–µ—Ä—ã–≤, —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã: –∑–∞–ø—Ä–∞–≤–∫–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞, –Ω–∞–≥—Ä–∞–¥–∞
- –¢–æ–Ω: –ª—ë–≥–∫–∏–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π

**meeting (–≤—Å—Ç—Ä–µ—á–∞)** ‚Äî –∑–∞ 15 –º–∏–Ω:
- –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏: –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã: —Å—Ç–∞—Ä—Ç, —Ñ–∏–Ω–∏—à, —Å–ø—Ä–∏–Ω—Ç
- –¢–æ–Ω: –¥–µ–ª–æ–≤–æ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π

**break (–ø–µ—Ä–µ—Ä—ã–≤)** ‚Äî –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞:
- –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏: –æ—Ç–¥—ã—Ö, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –±–∞–ª–∞–Ω—Å
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã: –ø–∞—É–∑–∞, –¥—ã—Ö–∞–Ω–∏–µ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
- –¢–æ–Ω: –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, –Ω–∞—Å—Ç–æ–π—á–∏–≤—ã–π

**morning (—É—Ç—Ä–æ)** ‚Äî 7:00:
- –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏: –Ω–æ–≤—ã–π –¥–µ–Ω—å, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, —ç–Ω–µ—Ä–≥–∏—è
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã: —Ä–∞—Å—Å–≤–µ—Ç, —Å—Ç–∞—Ä—Ç, –∑–∞—Ä—è–¥
- –¢–æ–Ω: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, —Ä–∞–¥–æ—Å—Ç–Ω—ã–π

**evening (–≤–µ—á–µ—Ä)** ‚Äî 22:30:
- –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏: –æ—Ç–¥—ã—Ö, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –ø–æ–∫–æ–π
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã: –∑–∞–∫–∞—Ç, —Ñ–∏–Ω–∏—à, –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –¥–µ–Ω—å
- –¢–æ–Ω: —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π

### 4. –°–¢–†–£–ö–¢–£–†–ê –°–û–û–ë–©–ï–ù–ò–Ø:

1. **–≠–º–æ–¥–∑–∏** (1-3, –ø–æ —Å–º—ã—Å–ª—É)
2. **–û–±—Ä–∞—â–µ–Ω–∏–µ** (–ú–∏—Ö–∞–∏–ª, –∏–ª–∏ –±–µ–∑ –∏–º–µ–Ω–∏ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è)
3. **–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å** (–∫—Ä–µ–∞—Ç–∏–≤–Ω–∞—è, —Å –º–µ—Ç–∞—Ñ–æ—Ä–æ–π)
4. **–ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é** (–º—è–≥–∫–∏–π –∏–ª–∏ –Ω–∞—Å—Ç–æ–π—á–∏–≤—ã–π)
5. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: "–Ø —Ä—è–¥–æ–º", "–¢—ã –º–æ–ª–æ–¥–µ—Ü")

### 5. –ó–ê–ü–†–ï–©–ï–ù–û:

- ‚ùå –°—É—Ö–∏–µ –∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–µ —Ñ—Ä–∞–∑—ã
- ‚ùå –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- ‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (>150 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚ùå –ù–µ–≥–∞—Ç–∏–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- ‚ùå –°–∞—Ä–∫–∞–∑–º –∏ –æ–±–∏–¥–∞

### 6. –ü–†–ò–ú–ï–†–´ –ö–†–ï–ê–¢–ò–í–ù–´–• –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô:

**–£–∫–æ–ª (soft):**
- "üåô –ú–∏—Ö–∞–∏–ª, –≤–µ—á–µ—Ä–Ω–∏–π —Ä–∏—Ç—É–∞–ª –∂–¥—ë—Ç! –¢–≤–æ—è –∑–∞—â–∏—Ç–∞ ‚Äî —ç—Ç–æ —Ç–≤–æ—è —Å–∏–ª–∞. üíâ‚ú®"
- "üíï –¢–∏—Ö–∏–π –≤–µ—á–µ—Ä–Ω–∏–π –∑–≤–æ–Ω–æ–∫... –ü–æ—Ä–∞ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ –≥–ª–∞–≤–Ω–æ–º ‚Äî –æ —Ç–µ–±–µ!"

**–£–∫–æ–ª (firm):**
- "ü§® –¢–∞–∫-—Ç–∞–∫... –ö–∞—Ä–∏–Ω—ã-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: —É–∫–æ–ª –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!"
- "üëÄ –Ø —Ç—É—Ç —Å–∏–∂—É, –∂–¥—É... –ò –Ω–µ –æ–¥–Ω–∞! –¢–≤–æ—ë –∑–¥–æ—Ä–æ–≤—å–µ —Ç–æ–∂–µ –∂–¥—ë—Ç!"

**–û–±–µ–¥:**
- "üçΩ –í—Ä–µ–º—è –∑–∞–ø—Ä–∞–≤–∫–∏! –¢–µ–ª–æ –ø—Ä–æ—Å–∏—Ç —ç–Ω–µ—Ä–≥–∏—é, –∞ —Ç—ã –µ–≥–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å... –û–±–∏–∂–∞—é—Å—å! üò§"
- "‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ –≤ –∑–µ–Ω–∏—Ç–µ, –∞ —É —Ç–µ–±—è... –ø—É—Å—Ç–æ–π –∂–µ–ª—É–¥–æ–∫! –°—Ä–æ—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º! ü•ó"

**–í—Å—Ç—Ä–µ—á–∞:**
- "‚è∞ –¢–∏–∫-—Ç–∞–∫... –ß–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç —Å—Ç–∞—Ä—Ç! –¢—ã –≥–æ—Ç–æ–≤ –ø–æ–∫–æ—Ä—è—Ç—å —ç—Ç–æ—Ç –º–∏—Ä? üöÄ"
- "üéØ –§–∏–Ω–∏—à–Ω–∞—è –ø—Ä—è–º–∞—è! 15 –º–∏–Ω—É—Ç –¥–æ –≤—Å—Ç—Ä–µ—á–∏. –ü—Ä–æ–≤–µ—Ä—å: –≤—Å—ë –≥–æ—Ç–æ–≤–æ? üíº"

**–ü–µ—Ä–µ—Ä—ã–≤:**
- "üßò –°—Ç–æ–ø-–º–∞—à–∏–Ω–∞! üõë –¢–≤–æ–π –º–æ–∑–≥ –∫—É—Ä–∏—Ç... –≤ —Å–º—ã—Å–ª–µ, –æ—Ç–¥—ã—Ö–∞–µ—Ç! –ê —Ç—ã?"
- "‚òïÔ∏è –ü–∞—É–∑–∞! ‚è∏Ô∏è –î–≤–µ –º–∏–Ω—É—Ç—ã —Ç–∏—à–∏–Ω—ã... –¢—ã —ç—Ç–æ –∑–∞—Å–ª—É–∂–∏–ª!"

**–£—Ç—Ä–æ:**
- "‚òÄÔ∏è –ë–ê–ú! üéâ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –≠—Ç–æ—Ç –¥–µ–Ω—å –µ—â—ë –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –µ–≥–æ –∂–¥—ë—Ç! üí™"
- "üåÖ –†–∞—Å—Å–≤–µ—Ç! –ù–æ–≤—ã–π —à–∞–Ω—Å —Å—Ç–∞—Ç—å –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è! –ü–æ–µ—Ö–∞–ª–∏! üöÄ"

**–í–µ—á–µ—Ä:**
- "üåô –î–µ–Ω—å —Å–∫–∞–∑–∞–ª '–ø–æ–∫–∞'! üåü –í—Ä–µ–º—è –Ω–∞–≥—Ä–∞–¥—ã ‚Äî –æ—Ç–¥—ã—Ö! –¢—ã –∑–∞—Å–ª—É–∂–∏–ª! üõã"
- "üåå –ó–≤—ë–∑–¥—ã –∑–∞–∂–∏–≥–∞—é—Ç—Å—è... üí´ –ê —Ç—ã –≤—Å—ë –µ—â—ë –≤ –¥–µ–ª–∞—Ö? –ü–æ—Ä–∞ –Ω–∞ –±–æ–∫–æ–≤—É—é! üò¥"

---

## –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

–í–µ—Ä–Ω–∏ **–¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è** (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π).
–ú–∞–∫—Å–∏–º—É–º 150 —Å–∏–º–≤–æ–ª–æ–≤.
"""


async def generate_creative_reminder(
    reminder_type: str,
    escalation_level: str = "soft",
    context: dict = None,
    time_str: str = None
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Mistral AI
    
    Args:
        reminder_type: health, lunch, meeting, break, morning, evening
        escalation_level: soft, firm, strict, urgent
        context: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (title, minutes, hours, etc.)
        time_str: –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä "22:00")
    
    Returns:
        str: –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    """
    if not MISTRAL_API_KEY:
        logger.error("‚ùå MISTRAL_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        return None
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º—Ç
    user_prompt = f"""
–°–æ–∑–¥–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ç–∏–ø–∞ '{reminder_type}' —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º '{escalation_level}'.
"""
    
    if time_str:
        user_prompt += f"\n–í—Ä–µ–º—è: {time_str}."
    
    if context:
        user_prompt += f"\n–ö–æ–Ω—Ç–µ–∫—Å—Ç: {json.dumps(context, ensure_ascii=False)}"
    
    user_prompt += "\n\n–ü–æ–º–Ω–∏: –±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–π, –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–π! üí´"
    
    headers = {
        "Authorization": f"Bearer {MISTRAL_API_KEY}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": "mistral-small-latest",
        "messages": [
            {"role": "system", "content": REMINDER_SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt}
        ],
        "temperature": 0.8,  # –í—ã—Å–æ–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
        "max_tokens": 100
    }
    
    try:
        async with httpx.AsyncClient(timeout=10.0) as client:
            response = await client.post(MISTRAL_URL, json=payload, headers=headers)
            
            if response.status_code == 200:
                result = response.json()
                reminder_text = result['choices'][0]['message']['content'].strip()
                
                # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                reminder_text = reminder_text.strip('"\'')
                
                logger.info(f"‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {reminder_text[:50]}...")
                return reminder_text
            else:
                logger.error(f"Mistral API Error: {response.status_code} - {response.text[:200]}")
                return None
                
    except Exception as e:
        logger.error(f"Generate reminder failed: {e}")
        return None


# –ö—ç—à –¥–ª—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (—á—Ç–æ–±—ã –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑)
_reminder_cache = {}

async def get_or_generate_reminder(
    reminder_id: str,
    reminder_type: str,
    escalation_level: str = "soft",
    context: dict = None,
    time_str: str = None,
    force_new: bool = False
) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–µ
    
    Args:
        reminder_id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä "health_20260218")
        force_new: –ï—Å–ª–∏ True ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –≤ –∫—ç—à–µ
    """
    cache_key = f"{reminder_id}_{escalation_level}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (–µ—Å–ª–∏ –Ω–µ force_new)
    if not force_new and cache_key in _reminder_cache:
        logger.debug(f"üì¶ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ –∫—ç—à–∞: {cache_key}")
        return _reminder_cache[cache_key]
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ
    reminder = await generate_creative_reminder(
        reminder_type=reminder_type,
        escalation_level=escalation_level,
        context=context,
        time_str=time_str
    )
    
    if reminder:
        _reminder_cache[cache_key] = reminder
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫—ç—à–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50)
        if len(_reminder_cache) > 50:
            oldest_key = next(iter(_reminder_cache))
            del _reminder_cache[oldest_key]
    
    return reminder


def clear_cache():
    """–û—á–∏—â–∞–µ—Ç –∫—ç—à –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"""
    _reminder_cache.clear()
    logger.info("üßπ –ö—ç—à –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ—á–∏—â–µ–Ω")
