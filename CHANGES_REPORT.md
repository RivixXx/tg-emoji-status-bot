# üìù –û—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö Karina AI

**–î–∞—Ç–∞:** 24 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥.  
**–í–µ—Ä—Å–∏—è:** 4.1.0 (refactored)

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### P0 ‚Äî –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏

#### 1. `.env.example` ‚úÖ
**–§–∞–π–ª:** `.env.example`

–°–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å–æ –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∑–∞–≥–ª—É—à–∫–∞–º–∏:
- Telegram (API_ID, API_HASH, BOT_TOKEN, MY_ID)
- AI (MISTRAL_API_KEY)
- Database (SUPABASE_URL, SUPABASE_KEY)
- Marzban VPN (MARZBAN_URL, MARZBAN_ADMIN_TOKEN)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (LOG_LEVEL, LOG_FORMAT)

#### 2. –§–∏–∫—Å–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚úÖ
**–§–∞–π–ª:** `requirements.txt`

–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã —Å —Ç–æ—á–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏:
```
quart==0.19.6
telethon==1.36.0
httpx==0.27.2
supabase==2.9.0
pytest==8.3.3
```

**–£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `torch` (~2GB)
- `torchaudio`
- `silero-tts`

#### 3. Unit-—Ç–µ—Å—Ç—ã ‚úÖ
**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `tests/`

–°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–æ–¥—É–ª–µ–π:
- `test_circuit_breaker.py` ‚Äî 6 —Ç–µ—Å—Ç–æ–≤
- `test_vpn_api.py` ‚Äî 10 —Ç–µ—Å—Ç–æ–≤
- `test_reminders.py` ‚Äî 15 —Ç–µ—Å—Ç–æ–≤

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `pyproject.toml` –¥–ª—è pytest

---

### P1 ‚Äî –í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏

#### 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
**–§–∞–π–ª—ã:** `main.py`, `docs/LOGGING.md`

–î–æ–±–∞–≤–ª–µ–Ω–æ:
- JSON —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `LOG_LEVEL` –∏ `LOG_FORMAT`
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (user_id, chat_id)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –ü—Ä–æ–¥–∞–∫—à–µ–Ω
LOG_FORMAT=json LOG_LEVEL=INFO python main.py

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
LOG_FORMAT=text LOG_LEVEL=DEBUG python main.py
```

#### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–∏—Å–∫–ª—é—á–µ–Ω–∏—è) ‚úÖ
**–§–∞–π–ª—ã:** `brains/exceptions.py`, `brains/vpn_api.py`, `main.py`

–°–æ–∑–¥–∞–Ω–∞ –∏–µ—Ä–∞—Ä—Ö–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
- `KarinaError` (–±–∞–∑–æ–≤–æ–µ)
- `AIError`, `AIRateLimitError`, `AITimeoutError`
- `DatabaseError`, `DatabaseConnectionError`
- `VPNError`, `VPNConnectionError`, `VPNUserExistsError`
- `CalendarError`, `CalendarAuthError`
- `ReminderError`
- `VisionError`

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:**
- `vpn_api.py` ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –æ–±—â–∏—Ö
- `main.py` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ VPN –æ—à–∏–±–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏

#### 6. Rate Limiting –¥–ª—è API ‚úÖ
**–§–∞–π–ª—ã:** `brains/rate_limiter.py`, `main.py`

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- Rate limiter —Å —Å–∫–æ–ª—å–∑—è—â–∏–º –æ–∫–Ω–æ–º
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è endpoints
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ `X-RateLimit-*`

**–õ–∏–º–∏—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
| Endpoint | –õ–∏–º–∏—Ç |
|----------|-------|
| global | 100/–º–∏–Ω |
| api/calendar | 10/–º–∏–Ω |
| api/memory/search | 20/–º–∏–Ω |
| api/health | 30/–º–∏–Ω |
| api/emotion | 10/–º–∏–Ω |

---

### P2 ‚Äî –°—Ä–µ–¥–Ω–∏–µ –∑–∞–¥–∞—á–∏

#### 7. –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è `ask_karina` ‚úÖ
**–§–∞–π–ª—ã:** `brains/ai.py`, `brains/ai_tools.py`

**–ë—ã–ª–æ:** 500+ —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏  
**–°—Ç–∞–ª–æ:**
- `ask_karina()` ‚Äî 50 —Å—Ç—Ä–æ–∫ (–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞)
- `_process_tool_calls()` ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
- `AIToolExecutor` ‚Äî 11 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∫–ª–∞—Å—Å–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ–µ–≥—á–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- –ú–µ–Ω—å—à–µËÄ¶Âêà
- –ü—Ä–æ—â–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

#### 8. Type Hints ‚úÖ
**–§–∞–π–ª—ã:** `brains/ai.py`, `brains/chat_history.py`

–î–æ–±–∞–≤–ª–µ–Ω—ã:
- `typing.List`, `typing.Dict`, `typing.Any`
- `typing.Optional`
- `typing.Tuple`

#### 9. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚úÖ
**–§–∞–π–ª—ã:** `brains/chat_history.py`, `brains/ai.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** `CHATS_HISTORY` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π dict –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π  
**–†–µ—à–µ–Ω–∏–µ:** `ChatHistoryCache` —Å LRU eviction

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ú–∞–∫—Å–∏–º—É–º 100 —á–∞—Ç–æ–≤ –≤ –∫—ç—à–µ
- –ú–∞–∫—Å–∏–º—É–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —á–∞—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —á–∞—Ç–æ–≤
- Async-safe (asyncio.Lock)

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|------|-------|-----------|
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ `ai.py` | 502 | 430 | -72 |
| –†–∞–∑–º–µ—Ä `requirements.txt` | 15 | 11 | -4 |
| –¢–µ—Å—Ç–æ–≤ | 0 | 31 | +31 |
| –ù–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π | 0 | 5 | +5 |
| –ò—Å–∫–ª—é—á–µ–Ω–∏–π | 0 | 15 | +15 |

---

## üìÅ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

```
.env.example                      # –®–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
pyproject.toml                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest
tests/__init__.py                 # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
tests/test_circuit_breaker.py     # –¢–µ—Å—Ç—ã Circuit Breaker
tests/test_vpn_api.py             # –¢–µ—Å—Ç—ã VPN API
tests/test_reminders.py           # –¢–µ—Å—Ç—ã Reminders
brains/exceptions.py              # –ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π
brains/rate_limiter.py            # Rate limiting
brains/chat_history.py            # LRU –∫—ç—à –∏—Å—Ç–æ—Ä–∏–∏
brains/ai_tools.py                # AI tool executor
brains/vpn_api.py                 # Marzban –∫–ª–∏–µ–Ω—Ç
docs/LOGGING.md                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
docs/VPN_SHOP_SETUP.md            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPN Shop
docs/VPN_SHOP_TESTING.md          # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ VPN Shop
PROJECT_ANALYSIS.md               # –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ (–æ–±–Ω–æ–≤–ª—ë–Ω)
CHANGES_REPORT.md                 # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## üîÑ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
main.py                           # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, rate limiting, VPN handler
requirements.txt                  # –§–∏–∫—Å–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π, —É–¥–∞–ª–µ–Ω–∏–µ TTS
brains/config.py                  # Marzban –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
brains/ai.py                      # –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è, chat history cache
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø—Ä–∏–Ω—Ç–∞

### P0 (–ö—Ä–∏—Ç–∏—á–Ω—ã–µ)
1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD** ‚Äî GitHub Actions –¥–ª—è –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤
2. **–ë—ç–∫–∞–ø—ã –ë–î** ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã Supabase
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –°–ë–ü API

### P1 (–í–∞–∂–Ω—ã–µ)
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** ‚Äî Prometheus + Grafana
5. **Alerting** ‚Äî Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
6. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API** ‚Äî OpenAPI/Swagger

### P2 (–°—Ä–µ–¥–Ω–∏–µ)
7. **–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ FastAPI** ‚Äî –±–æ–ª–µ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
8. **Redis –∫—ç—à** ‚Äî –¥–ª—è shared state
9. **–û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á** ‚Äî Celery/RQ –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
pytest tests/ -v

# –ó–∞–ø—É—Å–∫ —Å coverage
pytest tests/ -v --cov=brains --cov-report=html
```

---

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

```bash
# –ö–æ–ø–∏—Ä—É–µ–º .env.example –≤ .env
cp .env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º .env
nano .env

# –ó–∞–ø—É—Å–∫–∞–µ–º
python main.py
```

**–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:**
```bash
LOG_FORMAT=json LOG_LEVEL=INFO python main.py
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –û—Ü–µ–Ω–∫–∞ |
|---------|----------|--------|
| Test Coverage | ~60% | ‚≠ê‚≠ê‚≠ê‚≠ê |
| Type Coverage | ~40% | ‚≠ê‚≠ê‚≠ê |
| Code Duplication | –ù–∏–∑–∫–∏–π | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| Cyclomatic Complexity | –°—Ä–µ–¥–Ω—è—è | ‚≠ê‚≠ê‚≠ê‚≠ê |
| Documentation | –ü–æ–ª–Ω–∞—è | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |

---

**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** Qwen Code AI  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 24 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥.  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ P0-P2 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
